<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ü¶û OpenClaw Command Hub</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Monaco', monospace;
            background: #0a0a0f;
            color: #e0e0e0;
            min-height: 100vh;
            padding: 20px;
            font-size: 13px;
        }
        .container { max-width: 1800px; margin: 0 auto; }
        
        /* Header */
        header {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            border: 1px solid rgba(0, 217, 255, 0.2);
        }
        h1 {
            font-size: 2.5rem;
            background: linear-gradient(90deg, #00d9ff, #00ff88);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 5px;
        }
        .subtitle { color: #888; font-size: 0.95rem; }
        .refresh-time { color: #666; font-size: 0.8rem; margin-top: 8px; }
        
        /* Grid Layout */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
            align-items: start;
        }
        
        /* Column containers for independent stacking */
        .left-column, .right-column {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }


        /* Cards */
        .card {
            background: rgba(255,255,255,0.02);
            border-radius: 10px;
            padding: 18px;
            border: 1px solid rgba(255,255,255,0.06);
        }
        .card-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .card-icon { font-size: 1.8rem; margin-right: 12px; }
        .card-title { font-size: 1.1rem; font-weight: 600; flex: 1; }
        
        /* Status Indicators */
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }
        .status-dot.online { background: #00ff88; box-shadow: 0 0 8px #00ff88; }
        .status-dot.offline { background: #ff6b6b; box-shadow: 0 0 8px #ff6b6b; }
        .status-dot.warn { background: #feca57; box-shadow: 0 0 8px #feca57; }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* Service Item */
        .service-item, .file-item, .project-item {
            padding: 10px;
            margin-bottom: 8px;
            background: rgba(255,255,255,0.02);
            border-radius: 6px;
            border: 1px solid rgba(255,255,255,0.04);
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: all 0.2s;
        }
        .service-item:hover, .file-item:hover, .project-item:hover {
            background: rgba(255,255,255,0.04);
            border-color: rgba(0, 217, 255, 0.3);
        }
        
        .service-info, .file-info, .project-info { flex: 1; }
        .service-name, .file-name, .project-name {
            font-weight: 600;
            color: #fff;
            margin-bottom: 3px;
        }
        .service-detail, .file-path, .project-detail {
            color: #888;
            font-size: 0.85rem;
            font-family: 'Monaco', monospace;
        }
        
        /* Buttons */
        .btn {
            padding: 6px 12px;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 600;
            transition: all 0.2s;
            margin-left: 5px;
        }
        .btn-primary {
            background: linear-gradient(135deg, #00d9ff, #0088cc);
            color: #000;
        }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0, 217, 255, 0.4); }
        
        .btn-secondary {
            background: rgba(255,255,255,0.08);
            color: #ccc;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .btn-secondary:hover { background: rgba(255,255,255,0.12); }
        
        .btn-danger {
            background: rgba(255, 107, 107, 0.2);
            color: #ff6b6b;
            border: 1px solid #ff6b6b;
        }
        .btn-danger:hover { background: rgba(255, 107, 107, 0.3); }
        
        /* Terminal */
        .terminal {
            background: #000;
            border-radius: 8px;
            padding: 15px;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 0.85rem;
            color: #0f0;
            height: 300px;
            overflow-y: auto;
            border: 1px solid #333;
        }
        .terminal pre { margin: 0; white-space: pre-wrap; line-height: 1.4; }
        
        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-top: 10px;
        }
        .stat-box {
            background: rgba(255,255,255,0.02);
            padding: 12px;
            border-radius: 6px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.04);
        }
        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #00d9ff;
            margin-bottom: 5px;
        }
        .stat-label {
            font-size: 0.75rem;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .risk-pill {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 84px;
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 0.72rem;
            font-weight: 700;
            letter-spacing: 0.4px;
            border: 1px solid transparent;
        }
        .risk-pill.low { color: #00ff88; border-color: rgba(0, 255, 136, 0.5); background: rgba(0, 255, 136, 0.12); }
        .risk-pill.medium { color: #feca57; border-color: rgba(254, 202, 87, 0.5); background: rgba(254, 202, 87, 0.12); }
        .risk-pill.high { color: #ff9f43; border-color: rgba(255, 159, 67, 0.5); background: rgba(255, 159, 67, 0.12); }
        .risk-pill.critical { color: #ff6b6b; border-color: rgba(255, 107, 107, 0.5); background: rgba(255, 107, 107, 0.12); }
        .risk-pill.trouble { color: #feca57; border-color: rgba(254, 202, 87, 0.5); background: rgba(254, 202, 87, 0.12); }
        .risk-pill.bad { color: #ff6b6b; border-color: rgba(255, 107, 107, 0.5); background: rgba(255, 107, 107, 0.12); }
        
        /* Full Width */
        .full-width { grid-column: 1 / -1; }
        
        /* Actions */
        .actions { display: flex; gap: 8px; }
        
        /* Links */
        a { color: #00d9ff; text-decoration: none; }
        a:hover { text-decoration: underline; }
        
        /* Code */
        code {
            background: rgba(0, 217, 255, 0.1);
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Monaco', monospace;
            font-size: 0.85rem;
            color: #00d9ff;
        }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: rgba(255,255,255,0.02); }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.15); }
        
        /* App Grid Styles */
        .app-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            padding: 10px 0;
        }
        
        .app-card {
            background: rgba(255,255,255,0.03);
            border: 2px solid rgba(255,255,255,0.08);
            border-radius: 16px;
            padding: 20px 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            min-height: 160px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .app-card:hover {
            transform: translateY(-5px);
            background: rgba(255,255,255,0.06);
            border-color: var(--app-color);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3), 0 0 20px var(--app-color);
        }
        
        .app-card.stopped {
            opacity: 0.5;
            cursor: default;
        }
        
        .app-card.stopped:hover {
            transform: none;
            background: rgba(255,255,255,0.03);
            border-color: rgba(255,255,255,0.08);
            box-shadow: none;
        }
        
        .app-icon {
            font-size: 3rem;
            margin-bottom: 5px;
            filter: drop-shadow(0 0 10px currentColor);
            animation: pulse 2s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .app-card.stopped .app-icon {
            filter: none;
            animation: none;
            opacity: 0.4;
        }
        
        .app-status {
            position: absolute;
            top: 12px;
            right: 12px;
        }
        
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            position: relative;
        }
        
        .status-indicator.online {
            background: #00ff88;
            box-shadow: 0 0 10px #00ff88;
            animation: pulse-dot 2s ease-in-out infinite;
        }
        
        .status-indicator.offline {
            background: #666;
        }
        
        @keyframes pulse-dot {
            0%, 100% { 
                box-shadow: 0 0 10px currentColor;
                opacity: 1;
            }
            50% { 
                box-shadow: 0 0 20px currentColor;
                opacity: 0.8;
            }
        }
        
        .app-name {
            font-size: 0.85rem;
            font-weight: 600;
            color: #e0e0e0;
            margin-top: 5px;
            line-height: 1.2;
        }
        
        .app-port {
            font-size: 0.75rem;
            color: var(--app-color);
            font-family: 'Monaco', monospace;
            font-weight: 600;
            margin-top: 2px;
            opacity: 0.8;
        }


    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ü¶û OpenClaw Command Hub</h1>
            <p class="subtitle">System monitoring ‚Ä¢ Service management ‚Ä¢ File access</p>
            <p class="refresh-time" id="refreshTime">Loading...</p>
        </header>
        
        <!-- Main Dashboard Grid -->
        <div class="dashboard-grid">
            
            <!-- Left Column -->
            <div class="left-column">
                <!-- System Status -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-icon">‚ö°</div>
                        <div class="card-title">System Status</div>
                        <button class="btn btn-primary" style="margin-left: auto; padding: 6px 12px; font-size: 0.85rem;" onclick="openTerminal()">üìä Open Status TUI</button>
                    </div>
                    <div class="stats-grid">
                        <div class="stat-box">
                            <div class="stat-value" id="sessionCount">-</div>
                            <div class="stat-label">Sessions</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" id="tokensUsed">-</div>
                            <div class="stat-label">Tokens</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" id="uptime">-</div>
                            <div class="stat-label">Uptime</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" id="model">-</div>
                            <div class="stat-label">Model</div>
                        </div>
                    </div>
                </div>

                <!-- Gateway Pressure -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-icon">üö®</div>
                        <div class="card-title">Gateway Pressure</div>
                        <button id="pressureRefreshBtn" class="btn btn-secondary" style="margin-left: auto;" onclick="refreshPressureOnly()">üîÑ</button>
                        <div id="riskBandPill" class="risk-pill low">LOW</div>
                    </div>
                    <div class="stats-grid">
                        <div class="stat-box">
                            <div class="stat-value" id="riskScore">-</div>
                            <div class="stat-label">Risk Score</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" id="contextPressure">-</div>
                            <div class="stat-label">Context</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" id="queueDepth" style="font-size: 1.8rem;">
                                <span id="queueActive">-</span><span style="opacity: 0.5;">/</span><span id="queueWaiting">-</span><span style="opacity: 0.5;">/</span><span id="queueQueued">-</span>
                            </div>
                            <div class="stat-label">Active / Wait / Queue</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" id="gatewayMemory">-</div>
                            <div class="stat-label">Gateway RAM</div>
                        </div>
                    </div>
                    <div style="padding-top: 10px; display: flex; align-items: center; gap: 8px;">
                        <span class="service-detail">Memory Health:</span>
                        <span id="memoryHealthPill" class="risk-pill low">GOOD</span>
                    </div>
                    <div id="pressureEvents" class="service-detail" style="padding-top: 8px;">Loading pressure signals...</div>
                </div>
                
                <!-- Services -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-icon">üîß</div>
                        <div class="card-title">Services</div>
                    </div>
                    <div id="servicesList"></div>
                </div>
                
                <!-- Sub-Agents -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-icon">ü§ñ</div>
                        <div class="card-title">Sub-Agents</div>
                        <button class="btn btn-secondary" onclick="loadSessions()" style="margin-left: auto;">üîÑ</button>
                    </div>
                    <div id="subAgentsList"></div>
                </div>
                
                <!-- Files & Locations -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-icon">üìÅ</div>
                        <div class="card-title">Files & Locations</div>
                    </div>
                    <div id="filesList"></div>
                </div>
            </div>
            
            <!-- Right Column -->
            <div class="right-column">
                <!-- Channels -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-icon">üí¨</div>
                        <div class="card-title">Channels</div>
                    </div>
                    <div id="channelsList"></div>
                </div>
                
                <!-- Projects -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-icon">üéØ</div>
                        <div class="card-title">Projects</div>
                    </div>
                    <div id="projectsList"></div>
                </div>
                
                <!-- Code Stats -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-icon">üìä</div>
                        <div class="card-title">Lines Pushed</div>
                    </div>
                    <div id="codeStats"></div>
                </div>
                
                <!-- Cron Jobs -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-icon">‚è∞</div>
                        <div class="card-title">Scheduled Jobs</div>
                    </div>
                    <div id="cronList"></div>
                </div>
            </div>
            
            <!-- Terminal Output -->
            <div class="card full-width">
                <div class="card-header">
                    <div class="card-icon">üíª</div>
                    <div class="card-title">OpenClaw Status</div>
                    <button class="btn btn-secondary" onclick="refreshStatus()">üîÑ Refresh</button>
                </div>
                <div class="terminal" id="terminal">
                    <pre>Loading status...</pre>
                </div>
            </div>
        </div>
    </div>

    <script>
        let systemData = null;
        
        async function loadData() {
            try {
                const response = await fetch('/data');
                systemData = await response.json();
                render();
                updateRefreshTime();
            } catch (error) {
                console.error('Failed to load data:', error);
            }
        }
        
        function render() {
            if (!systemData) return;
            
            // System stats
            document.getElementById('sessionCount').textContent = systemData.session.active;
            document.getElementById('tokensUsed').textContent = systemData.session.tokensUsed;
            document.getElementById('uptime').textContent = systemData.session.lastActivity;
            const modelShort = systemData.model.primary.split('/').pop().replace('claude-', '').replace('-4-5', '');
            document.getElementById('model').textContent = modelShort;
            renderPressure(systemData.pressure || {});
            
            // Services
            // Services - App Icon Grid
            const servicesHtml = (() => {
                const icons = {
                    'Gateway': 'üåê',
                    'Voice Server': 'üîä',
                    'Job Dashboard': 'üíº',
                    'NYC Raves Dashboard': 'üéµ',
                    'Token Tracker': '‚ö°',
                    'Mission Control': 'üéõÔ∏è',
                    'Context Manager': 'üßπ',
                    'Activity Hub': 'ü¶û',
                    'Moltbook Dashboard': 'üì±',
                    'MonoClaw Dashboard': 'ü¶æ',
                    'Skill Builder Dashboard': 'üîç',
                    'Docker Agent Dashboard': 'üê≥',
                    'Gmail Inbox Check': 'üìß'
                };
                const colors = {
                    'Gateway': '#00d9ff',
                    'Voice Server': '#ff6b6b',
                    'Job Dashboard': '#feca57',
                    'NYC Raves Dashboard': '#ee5a6f',
                    'Token Tracker': '#00ff88',
                    'Mission Control': '#a29bfe',
                    'Context Manager': '#22c55e',
                    'Activity Hub': '#9b59b6',
                    'Moltbook Dashboard': '#e74c3c',
                    'MonoClaw Dashboard': '#ff9ff3',
                    'Skill Builder Dashboard': '#22c55e',
                    'Docker Agent Dashboard': '#3b82f6',
                    'Gmail Inbox Check': '#ea4335'
                };
                const urls = {
                    'Voice Server': 'http://localhost:18790/status',
                    'Job Dashboard': 'http://localhost:18791',
                    'NYC Raves Dashboard': 'http://localhost:18793',
                    'Token Tracker': 'http://localhost:18794',
                    'Mission Control': 'http://localhost:18795/hub',
                    'Context Manager': 'http://localhost:18800',
                    'Activity Hub': 'http://localhost:18796',
                    'Moltbook Dashboard': 'http://localhost:18797',
                    'MonoClaw Dashboard': 'http://localhost:18798',
                    'Skill Builder Dashboard': 'http://localhost:18799',
                    'Docker Agent Dashboard': 'http://localhost:9092'
                };
                
                const apps = systemData.services.map(s => {
                    const icon = icons[s.name] || '‚öôÔ∏è';
                    const color = colors[s.name] || '#888';
                    const url = urls[s.name];
                    const port = s.detail.match(/\d+/)?.[0] || '';
                    
                    // Special handling for controllable services (Gmail)
                    if (s.controllable) {
                        return `
                            <div class="app-card ${s.running ? 'running' : 'stopped'}" 
                                 style="--app-color: ${color}">
                                <div class="app-icon" style="color: ${color}">${icon}</div>
                                <div class="app-status">
                                    <span class="status-indicator ${s.running ? 'online' : 'offline'}"></span>
                                </div>
                                <div class="app-name">${s.name.replace(' Inbox Check', '')}</div>
                                <button class="btn ${s.running ? 'btn-danger' : 'btn-primary'}" 
                                        onclick="event.stopPropagation(); toggleGmailService(${!s.running})"
                                        style="margin-top: 8px; padding: 4px 8px; font-size: 0.75rem; width: 100%;">
                                    ${s.running ? 'Disable' : 'Enable'}
                                </button>
                            </div>
                        `;
                    }
                    
                    return `
                        <div class="app-card ${s.running ? 'running' : 'stopped'}" 
                             ${url && s.running ? `onclick="window.open('${url}', '_blank')"` : ''}
                             style="--app-color: ${color}">
                            <div class="app-icon" style="color: ${color}">${icon}</div>
                            <div class="app-status">
                                <span class="status-indicator ${s.running ? 'online' : 'offline'}"></span>
                            </div>
                            <div class="app-name">${s.name.replace(' Dashboard', '')}</div>
                            ${port ? `<div class="app-port">:${port}</div>` : ''}
                        </div>
                    `;
                }).join('');
                
                return `<div class="app-grid">${apps}</div>`;
            })();
            document.getElementById('servicesList').innerHTML = servicesHtml;
            
            // Channels
            const channelsHtml = systemData.channels.map(c => `
                <div class="service-item">
                    <div class="service-info">
                        <div class="service-name">
                            <span class="status-dot ${c.state === 'OK' ? 'online' : c.state === 'WARN' ? 'warn' : 'offline'}"></span>
                            ${c.name}
                        </div>
                        <div class="service-detail">${c.detail}</div>
                    </div>
                </div>
            `).join('');
            document.getElementById('channelsList').innerHTML = channelsHtml;
            
            // Projects
            const projects = [
                { name: 'Job Search Tracker', url: 'http://localhost:18791', detail: '11 companies tracked' },
                { name: 'NYC Raves', url: 'http://localhost:18793', detail: '24 events this week' },
                { name: 'Token Usage Tracker', url: 'http://localhost:18794', detail: 'Real-time token monitoring' },
                { name: 'Mission Control', url: 'http://localhost:18795', detail: 'This dashboard' },
                { name: 'Context Manager', url: 'http://localhost:18800', detail: 'ctxreport + safe ctxprune' },
                { name: 'Activity Hub', url: 'http://localhost:18796', detail: 'Track all agent activity' },
                { name: 'MonoClaw Dashboard', url: 'http://localhost:18798', detail: '19 projects dashboard' },
                { name: 'Vision Controller', url: 'http://localhost:18799', detail: 'Hand gesture recognition' },
                { name: 'Docker Agent System', url: 'http://localhost:9092', detail: 'Container agent runtime' }
            ];
            const projectsHtml = projects.map(p => `
                <div class="project-item" onclick="window.open('${p.url}', '_blank')">
                    <div class="project-info">
                        <div class="project-name">${p.name}</div>
                        <div class="project-detail">${p.detail}</div>
                    </div>
                </div>
            `).join('');
            document.getElementById('projectsList').innerHTML = projectsHtml;
            
            // Files
            const files = [
                { name: 'Config', path: '~/.openclaw/openclaw.json', action: 'code' },
                { name: 'Workspace', path: '~/.openclaw/workspace', action: 'finder' },
                { name: 'Gateway Logs', path: '~/.openclaw/logs', action: 'finder' },
                { name: 'Voice Server Logs', path: '~/.openclaw/voice-server', action: 'finder' },
                { name: 'AGENTS.md', path: '~/.openclaw/workspace/AGENTS.md', action: 'code' },
                { name: 'TOOLS.md', path: '~/.openclaw/workspace/TOOLS.md', action: 'code' }
            ];
            const filesHtml = files.map(f => `
                <div class="file-item">
                    <div class="file-info">
                        <div class="file-name">${f.name}</div>
                        <div class="file-path">${f.path}</div>
                    </div>
                    <div class="actions">
                        <button class="btn btn-secondary" onclick="openPath('${f.path}', 'finder')">üìÅ</button>
                        <button class="btn btn-secondary" onclick="openPath('${f.path}', 'code')">üíª</button>
                    </div>
                </div>
            `).join('');
            document.getElementById('filesList').innerHTML = filesHtml;
            
            // Cron
            const cronHtml = systemData.cron.map(c => `
                <div class="service-item">
                    <div class="service-info">
                        <div class="service-name">${c.name}</div>
                        <div class="service-detail">${c.schedule} ‚Ä¢ Next: ${c.nextRun}</div>
                    </div>
                </div>
            `).join('');
            document.getElementById('cronList').innerHTML = cronHtml;
        }
        
        async function loadCodeStats() {
            try {
                const response = await fetch('/api/code-stats');
                const data = await response.json();
                
                if (data.success) {
                    const stats = data.stats;
                    
                    const formatNumber = (num) => {
                        if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
                        if (num >= 1000) return (num / 1000).toFixed(1) + 'k';
                        return num.toString();
                    };
                    
                    const statItem = (label, ins, dels, net) => `
                        <div class="service-item" style="display: block;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                                <div class="service-name">${label}</div>
                                <div style="color: ${net >= 0 ? '#00ff88' : '#ff6b6b'}; font-weight: 600;">
                                    ${net >= 0 ? '+' : ''}${formatNumber(net)}
                                </div>
                            </div>
                            <div class="service-detail" style="display: flex; gap: 12px;">
                                <span style="color: #00ff88;">+${formatNumber(ins)}</span>
                                <span style="color: #ff6b6b;">-${formatNumber(dels)}</span>
                            </div>
                        </div>
                    `;
                    
                    const html = `
                        ${statItem('Today', stats.today.insertions, stats.today.deletions, stats.today.net)}
                        ${statItem('This Week', stats.week.insertions, stats.week.deletions, stats.week.net)}
                        ${statItem('This Month', stats.month.insertions, stats.month.deletions, stats.month.net)}
                    `;
                    
                    document.getElementById('codeStats').innerHTML = html;
                }
            } catch (error) {
                console.error('Failed to load code stats:', error);
                document.getElementById('codeStats').innerHTML = '<div class="service-detail" style="padding: 10px; color: #888;">Failed to load stats</div>';
            }
        }
        
        async function refreshStatus() {
            document.getElementById('terminal').innerHTML = '<pre>Fetching openclaw status...</pre>';
            try {
                const response = await fetch('/api/openclaw-status');
                const data = await response.json();
                document.getElementById('terminal').innerHTML = `<pre>${data.output || 'No output'}</pre>`;
            } catch (error) {
                document.getElementById('terminal').innerHTML = `<pre style="color: #ff6b6b;">Error: ${error.message}</pre>`;
            }
        }
        
        async function openTerminal() {
            try {
                await fetch('/api/open-terminal', { method: 'POST' });
            } catch (error) {
                alert('Failed to open terminal');
            }
        }
        
        async function openPath(path, type) {
            const expandedPath = path.replace('~', '/Users/matthew');
            try {
                if (type === 'finder') {
                    await fetch('/api/open-finder', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ path: expandedPath })
                    });
                } else if (type === 'code') {
                    await fetch('/api/open-vscode', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ path: expandedPath })
                    });
                }
            } catch (error) {
                alert(`Failed to open ${path}`);
            }
        }
        
        async function toggleGmailService(enabled) {
            try {
                const response = await fetch('/api/toggle-gmail', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ enabled })
                });
                const result = await response.json();
                
                if (result.success) {
                    // Reload data to update UI
                    await loadData();
                } else {
                    alert(`Failed to ${enabled ? 'enable' : 'disable'} Gmail: ${result.error}`);
                }
            } catch (error) {
                alert(`Failed to toggle Gmail: ${error.message}`);
            }
        }
        
        function updateRefreshTime() {
            const now = new Date().toLocaleTimeString();
            document.getElementById('refreshTime').textContent = `Last updated: ${now}`;
        }

        function renderPressure(pressure) {
            const riskScore = pressure.riskScore ?? 0;
            const riskBand = (pressure.riskBand || 'LOW').toLowerCase();
            const contextPct = pressure.context?.pct ?? 0;
            const laneWaitMs = pressure.events?.swarmLaneWaitMaxMs ?? 0;
            const gatewayQueue = pressure.gatewayQueue || {};

            // Heartbeat-based queue data (primary, real-time)
            const hbFresh = !!gatewayQueue.heartbeatFresh;
            const hbQueued = Number.isFinite(gatewayQueue.sessionQueued) ? gatewayQueue.sessionQueued : null;
            const hbActive = Number.isFinite(gatewayQueue.sessionActive) ? gatewayQueue.sessionActive : null;
            const hbWaiting = Number.isFinite(gatewayQueue.sessionWaiting) ? gatewayQueue.sessionWaiting : null;
            const hbAgeSec = Number.isFinite(gatewayQueue.heartbeatAgeSec) ? gatewayQueue.heartbeatAgeSec : null;
            const deliveryPending = Number.isFinite(gatewayQueue.deliveryPending) ? gatewayQueue.deliveryPending : 0;
            const lastHb = gatewayQueue.lastHeartbeat || null;

            // Legacy lane-wait data (fallback)
            const queueLatest = Number.isFinite(gatewayQueue.latestAhead) ? gatewayQueue.latestAhead : null;
            const queueMax = Number.isFinite(gatewayQueue.maxAhead) ? gatewayQueue.maxAhead : 0;
            const queueAgeSec = Number.isFinite(gatewayQueue.telemetryAgeSec) ? gatewayQueue.telemetryAgeSec : null;
            const queueInferred = !!gatewayQueue.inferred;
            const queueLastObserved = Number.isFinite(gatewayQueue.lastObservedAhead) ? gatewayQueue.lastObservedAhead : null;
            const queueLastObservedAgeSec = Number.isFinite(gatewayQueue.lastObservedAgeSec) ? gatewayQueue.lastObservedAgeSec : null;

            const gatewayMemory = pressure.gatewayMemory || {};
            const gatewayMemoryMb = gatewayMemory.memoryMb;
            const gatewayMemoryBand = gatewayMemory.band || 'UNKNOWN';
            const memoryDisplay = Number.isFinite(gatewayMemoryMb) ? `${gatewayMemoryMb}MB` : 'n/a';

            document.getElementById('riskScore').textContent = riskScore;
            document.getElementById('contextPressure').textContent = `${contextPct}%`;

            // Gateway Queue stats: prefer heartbeat, fall back to lane-wait, then infer from silence
            let activeDisplay, waitingDisplay, queuedDisplay, queueSource;
            if (hbFresh && hbActive !== null && hbWaiting !== null && hbQueued !== null) {
                // Real-time heartbeat data (diagnostic heartbeat every 30s)
                activeDisplay = String(hbActive);
                waitingDisplay = String(hbWaiting);
                queuedDisplay = String(hbQueued);
                queueSource = 'heartbeat';
            } else if (hbQueued !== null) {
                // Partial heartbeat data - show queued only
                activeDisplay = '-';
                waitingDisplay = '-';
                queuedDisplay = String(hbQueued);
                queueSource = 'partial-heartbeat';
            } else if (queueLatest !== null) {
                // Lane-wait diagnostic logged within lookback window
                activeDisplay = '-';
                waitingDisplay = '-';
                queuedDisplay = `${queueInferred ? '~' : ''}${queueLatest}`;
                queueSource = 'lane-wait';
            } else if (lastHb && Number.isFinite(lastHb.queued)) {
                // Stale heartbeat: show last known value with ? marker
                activeDisplay = lastHb.active ? String(lastHb.active) + '?' : '-';
                waitingDisplay = lastHb.waiting ? String(lastHb.waiting) + '?' : '-';
                queuedDisplay = `${lastHb.queued}?`;
                queueSource = 'stale-heartbeat';
            } else if (queueLastObserved !== null && queueLastObservedAgeSec !== null && queueLastObservedAgeSec < 3600) {
                // Recent lane-wait observation (within 1hr)
                activeDisplay = '-';
                waitingDisplay = '-';
                queuedDisplay = `${queueLastObserved}?`;
                queueSource = 'last-observed';
            } else {
                // No congestion signals at all = system is idle/healthy = queue is 0
                activeDisplay = '0';
                waitingDisplay = '0';
                queuedDisplay = '0';
                queueSource = 'inferred-idle';
            }
            document.getElementById('queueActive').textContent = activeDisplay;
            document.getElementById('queueWaiting').textContent = waitingDisplay;
            document.getElementById('queueQueued').textContent = queuedDisplay;
            document.getElementById('gatewayMemory').textContent = memoryDisplay;

            const pill = document.getElementById('riskBandPill');
            pill.textContent = pressure.riskBand || 'LOW';
            pill.className = `risk-pill ${riskBand}`;

            const memoryPill = document.getElementById('memoryHealthPill');
            let memoryHealthText = 'GOOD';
            let memoryHealthClass = 'low';
            if (gatewayMemoryBand === 'ELEVATED' || gatewayMemoryBand === 'HIGH') {
                memoryHealthText = 'TROUBLE';
                memoryHealthClass = 'trouble';
            } else if (gatewayMemoryBand === 'CRITICAL') {
                memoryHealthText = 'BAD';
                memoryHealthClass = 'bad';
            } else if (gatewayMemoryBand === 'UNKNOWN') {
                memoryHealthText = 'UNKNOWN';
                memoryHealthClass = 'medium';
            }
            memoryPill.textContent = memoryHealthText;
            memoryPill.className = `risk-pill ${memoryHealthClass}`;

            // Build pressure events detail text
            const events = pressure.events || {};
            const lookback = pressure.lookbackMinutes || 10;

            // Heartbeat telemetry line
            let hbLine = '';
            if (hbFresh && hbQueued !== null) {
                hbLine = `sessions: <code>active=${hbActive} waiting=${hbWaiting} queued=${hbQueued}</code> <code>(${hbAgeSec}s ago)</code>`;
            } else if (lastHb) {
                hbLine = `sessions: <code>active=${lastHb.active} waiting=${lastHb.waiting} queued=${lastHb.queued}</code> <code>(stale, ${lastHb.ageSec}s ago)</code>`;
            } else {
                hbLine = `sessions: <code>idle (no recent activity)</code>`;
            }

            // Delivery queue line
            const deliveryLine = `delivery queue: <code>${deliveryPending} pending</code>`;

            // Legacy lane-wait line
            let laneLine = '';
            if (queueLatest !== null) {
                laneLine = `lane queueAhead: <code>${queueInferred ? '~' : ''}${queueLatest}, max ${queueMax}</code>${queueAgeSec !== null ? ` <code>(${queueAgeSec}s ago)</code>` : ''}`;
            } else if (queueLastObserved !== null) {
                laneLine = `lane queueAhead: <code>last seen ${queueLastObserved} (${queueLastObservedAgeSec ?? '?'}s ago)</code>`;
            } else {
                laneLine = `lane queueAhead: <code>none</code>`;
            }

            document.getElementById('pressureEvents').innerHTML = `
                Last ${lookback}m ‚Ä¢ ordering conflicts: <code>${events.orderingConflicts ?? 0}</code> ‚Ä¢
                no-reply events: <code>${events.noReplyEvents ?? 0}</code> ‚Ä¢
                restarts: <code>${events.restarts ?? 0}</code> ‚Ä¢
                restart disconnects: <code>${events.serviceRestartDisconnects ?? 0}</code> ‚Ä¢
                embedded timeouts: <code>${events.embeddedTimeouts ?? 0}</code> ‚Ä¢
                ${hbLine} ‚Ä¢
                ${deliveryLine} ‚Ä¢
                ${laneLine} ‚Ä¢
                lane wait max: <code>${laneWaitMs ? `${Math.round(laneWaitMs / 1000)}s` : '0s'}</code> ‚Ä¢
                gateway memory: <code>${gatewayMemoryBand}${Number.isFinite(gatewayMemoryMb) ? ` (${gatewayMemoryMb}MB)` : ''}</code>
            `;
        }

        async function refreshPressureOnly() {
            const btn = document.getElementById('pressureRefreshBtn');
            if (btn) {
                btn.disabled = true;
                btn.textContent = '‚è≥';
            }
            try {
                const response = await fetch('/data');
                const data = await response.json();
                if (data && data.pressure) {
                    renderPressure(data.pressure);
                }
                updateRefreshTime();
            } catch (error) {
                console.error('Failed to refresh pressure data:', error);
            } finally {
                if (btn) {
                    btn.disabled = false;
                    btn.textContent = 'üîÑ';
                }
            }
        }
        
        // Sub-Agents
        let sessionsData = null;
        
        async function loadSessions() {
            try {
                const response = await fetch('/api/sessions');
                const data = await response.json();
                if (data.success) {
                    sessionsData = data.sessions;
                    renderSubAgents();
                }
            } catch (error) {
                console.error('Failed to load sessions:', error);
            }
        }
        
        function renderSubAgents() {
            if (!sessionsData || !sessionsData.sessions) {
                document.getElementById('subAgentsList').innerHTML = '<div class="service-detail" style="padding: 10px; color: #888;">No agents running</div>';
                return;
            }
            
            // Show main agent and sub-agents (exclude cron/hook sessions which are background tasks)
            const agents = sessionsData.sessions.filter(s => 
                !s.key.includes(':cron:') && 
                !s.key.includes(':hook:')
            );
            
            if (agents.length === 0) {
                document.getElementById('subAgentsList').innerHTML = '<div class="service-detail" style="padding: 10px; color: #888;">No agents running</div>';
                return;
            }
            
            const html = agents.map(agent => {
                // Calculate age
                const ageMinutes = Math.floor(agent.ageMs / 60000);
                const ageText = ageMinutes < 1 ? 'Just now' : 
                               ageMinutes < 60 ? `${ageMinutes}m ago` : 
                               `${Math.floor(ageMinutes / 60)}h ${ageMinutes % 60}m ago`;
                
                // Get model name (short version)
                const modelShort = agent.model ? agent.model.split('/').pop().replace('claude-', '').replace('-4-5', '') : 'default';
                
                // Extract agent ID from key (last part)
                const agentId = agent.key.split(':').pop().substring(0, 8);
                
                // Determine display name
                let displayName;
                if (agent.key === 'agent:main:main') {
                    displayName = 'ü¶û Main Agent';
                } else if (agent.label) {
                    displayName = agent.label;
                } else if (agent.key.includes('subagent')) {
                    displayName = `sub-agent-${agentId}`;
                } else {
                    displayName = agentId;
                }
                
                // Format tokens if available
                const tokenInfo = agent.totalTokens ? 
                    `${Math.round(agent.totalTokens / 1000)}k tokens` : 
                    'Starting...';
                
                // Status based on recent activity (5 minutes for active work)
                const isRecent = agent.ageMs < 300000; // Active in last 5 minutes
                const statusDot = isRecent ? 'online' : 'warn';
                const statusText = isRecent ? 'Working' : 'Idle';
                
                return `
                    <div class="service-item" style="cursor: pointer;" onclick="viewAgentDetails('${agent.key}', '${displayName}', '${agentId}')">
                        <div class="service-info">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                <span class="status-dot ${statusDot}"></span>
                                <div class="service-name">${displayName}</div>
                            </div>
                            <div class="service-detail">${statusText} ‚Ä¢ ${modelShort} ‚Ä¢ ${tokenInfo}</div>
                            <div class="service-detail" style="font-size: 0.8rem; color: #666;">Last activity: ${ageText}</div>
                        </div>
                        <button class="btn btn-secondary" onclick="event.stopPropagation(); viewAgentDetails('${agent.key}', '${displayName}', '${agentId}')">üìã</button>
                    </div>
                `;
            }).join('');
            
            document.getElementById('subAgentsList').innerHTML = html;
        }
        
        // View agent details
        async function viewAgentDetails(sessionKey, displayName, agentId) {
            try {
                const response = await fetch(`/api/sessions/history?sessionKey=${encodeURIComponent(sessionKey)}`);
                const data = await response.json();
                
                if (data.success) {
                    showAgentModal(displayName, agentId, sessionKey, data.history);
                }
            } catch (error) {
                console.error('Failed to load agent history:', error);
                alert('Failed to load agent details');
            }
        }
        
        function showAgentModal(displayName, agentId, sessionKey, history) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.8);
                z-index: 9999;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 20px;
            `;
            
            const content = document.createElement('div');
            content.style.cssText = `
                background: #1a1a2e;
                border-radius: 12px;
                max-width: 900px;
                max-height: 80vh;
                width: 100%;
                overflow: hidden;
                display: flex;
                flex-direction: column;
            `;
            
            // Extract work done from history
            const toolCalls = history.filter(msg => 
                msg.role === 'assistant' && 
                msg.content && 
                msg.content.some(c => c.type === 'toolCall')
            );
            
            const activities = [];
            toolCalls.forEach(msg => {
                msg.content.forEach(c => {
                    if (c.type === 'toolCall') {
                        let action = '';
                        let detail = '';
                        
                        if (c.name === 'write') {
                            action = 'üìù Created file';
                            detail = c.arguments.path.split('/').pop();
                        } else if (c.name === 'edit') {
                            action = '‚úèÔ∏è Modified file';
                            detail = c.arguments.path.split('/').pop();
                        } else if (c.name === 'exec') {
                            action = '‚ö° Executed command';
                            detail = c.arguments.command.substring(0, 50);
                        } else if (c.name === 'read') {
                            action = 'üëÄ Read file';
                            detail = c.arguments.path.split('/').pop();
                        } else {
                            action = `üîß ${c.name}`;
                            detail = JSON.stringify(c.arguments).substring(0, 50);
                        }
                        
                        activities.push({ action, detail, timestamp: new Date(msg.timestamp || Date.now()).toLocaleTimeString() });
                    }
                });
            });
            
            content.innerHTML = `
                <div style="padding: 24px; border-bottom: 1px solid rgba(255,255,255,0.1);">
                    <h2 style="color: #00d9ff; margin: 0; font-size: 24px;">${displayName}</h2>
                    <p style="color: #888; margin: 8px 0 0 0; font-size: 14px;">${sessionKey}</p>
                    <p style="color: #666; margin: 4px 0 0 0; font-size: 12px;">Agent ID: ${agentId}</p>
                </div>
                
                <div style="padding: 24px; overflow-y: auto; flex: 1;">
                    <h3 style="color: #fff; margin: 0 0 16px 0; font-size: 18px;">Activity Timeline (${activities.length} actions)</h3>
                    
                    ${activities.length === 0 ? '<p style="color: #888;">No activities recorded yet</p>' : ''}
                    
                    <div style="display: flex; flex-direction: column; gap: 12px;">
                        ${activities.map(act => `
                            <div style="
                                background: rgba(255,255,255,0.02);
                                border: 1px solid rgba(255,255,255,0.06);
                                border-radius: 8px;
                                padding: 12px;
                            ">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 4px;">
                                    <span style="color: #fff; font-weight: 600; font-size: 14px;">${act.action}</span>
                                    <span style="color: #666; font-size: 12px;">${act.timestamp}</span>
                                </div>
                                <div style="color: #888; font-size: 13px; font-family: Monaco, monospace;">${act.detail}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <div style="padding: 16px; border-top: 1px solid rgba(255,255,255,0.1); display: flex; gap: 12px;">
                    <button onclick="window.open('http://localhost:18796', '_blank')" style="
                        flex: 1;
                        background: rgba(0, 217, 255, 0.2);
                        color: #00d9ff;
                        border: 1px solid #00d9ff;
                        padding: 10px;
                        border-radius: 8px;
                        cursor: pointer;
                        font-weight: 600;
                    ">ü¶û View in Activity Hub</button>
                    <button onclick="this.closest('[style*=fixed]').remove()" style="
                        flex: 1;
                        background: rgba(255,255,255,0.08);
                        color: #ccc;
                        border: 1px solid rgba(255,255,255,0.1);
                        padding: 10px;
                        border-radius: 8px;
                        cursor: pointer;
                        font-weight: 600;
                    ">Close</button>
                </div>
            `;
            
            modal.appendChild(content);
            document.body.appendChild(modal);
            
            modal.onclick = (e) => {
                if (e.target === modal) modal.remove();
            };
        }
        
        // Initial load
        loadData();
        refreshStatus();
        loadSessions();
        loadCodeStats();
        
        // Auto-refresh every 30 seconds
        setInterval(loadData, 30000);
        setInterval(loadSessions, 10000); // Refresh sessions every 10 seconds
        setInterval(loadCodeStats, 60000); // Refresh code stats every minute
    </script>
    
    <script>
/**
 * Smart Hub Navigation
 * Finds existing Command Hub tab in current window or opens new one
 * Uses BroadcastChannel API to communicate between tabs
 */

const HUB_URL = 'http://localhost:18795/hub';
const HUB_CHANNEL = 'openclaw-hub-channel';

function navigateToHub(event) {
    // Prevent default link behavior
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }
    
    // Create a broadcast channel to ask if hub is already open
    const bc = new BroadcastChannel(HUB_CHANNEL);
    let hubFound = false;
    let timeout;
    
    // Listen for response from hub
    bc.onmessage = (e) => {
        if (e.data.type === 'hub-present') {
            hubFound = true;
            clearTimeout(timeout);
            bc.close();
            // Hub is open and will focus itself - we do nothing
        }
    };
    
    // Ask if hub is open
    bc.postMessage({ type: 'hub-ping' });
    
    // Wait 100ms for response
    timeout = setTimeout(() => {
        bc.close();
        if (!hubFound) {
            // No hub found, open new one
            window.open(HUB_URL, 'command-hub');
        }
    }, 100);
    
    return false; // Extra safety to prevent default
}

// If this page IS the hub, respond to pings
if (window.location.href.includes('localhost:18795')) {
    const bc = new BroadcastChannel(HUB_CHANNEL);
    bc.onmessage = (e) => {
        if (e.data.type === 'hub-ping') {
            // We are the hub! Send confirmation
            bc.postMessage({ type: 'hub-present' });
            // Try to focus ourselves (without reload)
            try {
                if (document.hidden || !document.hasFocus()) {
                    window.focus();
                }
            } catch (err) {
                // Focus might fail in some browsers, that's okay
                console.log('Could not focus hub tab');
            }
        }
    };
}
    </script>
</body>
</html>
